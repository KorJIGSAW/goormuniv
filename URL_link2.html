<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>댓칼코마니</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">

    <link rel="stylesheet" href="css/URL_link2.css">
    <link rel="shortcut icon" href="images/body_bg.png">
    <script src="js/jquery.min.js"></script>
    <script src="js/index.js"></script>
</head>

<body>
    <div id="wrap">
        <header class="header">
            <h1 class="logo">
                <a href="index.html">댓칼코마니<br></a>
            </h1>
            <nav class="nav">
                <ul class="gnb">
                    <li><a href="URL_link2.html">BACKGROUD</a><span class="sub_menu_toggle_btn">하위 메뉴 토글 버튼</span></li>
                    <li><a href="about.html">ABOUT</a><span class="sub_menu_toggle_btn">하위 메뉴 토글 버튼</span></li>
                    <li><a href="index.html">START NOW</a><span class="sub_menu_toggle_btn">하위 메뉴 토글 버튼</span></li>
                </ul>
            </nav>
            <span class="menu_toggle_btn">전체 메뉴 토글 버튼</span>
        </header>
    </div>
    <section class="chatbox_section">
    <div class="chat-box" id="chatBox">
        <!-- 대화 메시지가 여기에 동적으로 추가됩니다 -->
    </div>
    <input type="text" id="urlInput" placeholder="웹툰 URL을 입력해주세요">
    <button id="fetchButton">결과 보기</button>
    <div id="result"></div>
</section>
    <script>
        function addMessageToChatBox(message, type, isHtml = false) {
            const chatBox = document.getElementById('chatBox');
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', type + '-message');

            const textElement = document.createElement('div');
            textElement.classList.add('text');
            if (isHtml) {
                textElement.innerHTML = message; // HTML로 처리
            } else {
                textElement.textContent = message; // 텍스트로 처리
            }

            messageElement.appendChild(textElement);
            chatBox.appendChild(messageElement);
        }

        // 페이지 로딩 시 기본 메시지 추가
        window.onload = function () {
            addMessageToChatBox('안녕하세요!', 'assistant');
            addMessageToChatBox('댓글을 보고싶은 웹툰의 URL을 입력해주세요.', 'assistant');
        };

        document.getElementById('fetchButton').addEventListener('click', function () {
            const urlInput = document.getElementById('urlInput').value;
            if (!urlInput) {
                alert('URL을 입력해주세요.');
                return;
            }

            //사용자가 입력한 URL을 사용자의 말풍선으로 표시
            addMessageToChatBox(urlInput, 'user');

            const apiEndpoint = 'https://decalcomanie-yebvymrbqa-du.a.run.app/chat';
            const data = {
                url: urlInput
            };
            fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답이 올바르지 않습니다.');
                    }
                    return response.json();
                })
                // .then(data => {
                //     console.log(data);
                //     // API 호출 결과를 사용자에게 표시
                //     addMessageToChatBox(JSON.stringify(data, null, 2), 'assistant');
                // })
                .then(data => {
                    console.log(data);
                    const feedbackWithLineBreaks = data.feedback.replace(/(?<!^)(\d+\.\s)/g, '\n<br>$1');
                    // API 호출 결과 중 "feedback" 키에 해당하는 값만 사용자에게 표시
                    addMessageToChatBox(feedbackWithLineBreaks, 'assistant', true);
                })

                .catch(error => {
                    console.error('API 호출에 실패했습니다.', error);
                    // 에러 메시지를 사용자에게 표시
                    addMessageToChatBox('API 호출에 실패했습니다: ' + error, 'user');
                });
        });
    </script>
</body>

</html>